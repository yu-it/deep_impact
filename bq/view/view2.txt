select
	IDM as val,
	count(1) as num_rows,
	count(distinct IDM) as num_distinct,
	max(IDM) as max_values,
	min(IDM) as min_values,
	avg(safe_cast(IDM as numeric)) as avg_values,
	stddev(safe_cast(IDM as numeric)) as stddev_values,
	countif(safe_cast(IDM as numeric) = 0) as num_zero,
	countif(IDM is null) as num_null,
	max(without_error.IDM) as max_values_without_error,
	min(without_error.IDM) as min_values_without_error,
	nest(top(IDM, 10) ,count(1)) as top_10
from 
	(
		select 
			IDM,
			struct(
				case when abs(safe_cast(IDM as numeric) - avg(safe_cast(IDM as numeric)) over (partition by null)) / stddev(safe_cast(IDM as numeric)) over (partition by null) > 3 
				then null else IDM end as IDM
			) without_error
		from
			`yu-it-base.jrdb_raw_data.a_kyi` as kyi
	) as tbl
